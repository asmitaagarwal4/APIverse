# .gitlab-ci.yml
# CI/CD Pipeline stages run sequentially unless dependencies (needs) are defined
stages:
  - test
  - build
  - deploy
# Global Variables: Add your environment & secret keys here or via GitLab CI/CD Settings for security
variables:
  SECRET_DETECTION_ENABLED: 'true'
  # Example environment variables (DO NOT hardcode secrets here in production)
  # DB_USERNAME: "your_db_username"
  # DB_PASSWORD: "your_db_password"
  # API_KEY: "your_api_key"
  # Any sensitive key should be set securely via GitLab -> Settings -> CI/CD -> Variables.
# Secret Detection for API keys/secrets accidentally committed to the repo
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
# Backend Testing (Python)
test-backend:
  stage: test
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      exists:
        - backend/
  image: python:3.11-slim 
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio httpx asgi-lifespan
  script:
    - pytest tests/test_main.py --maxfail=1 --disable-warnings -v

build:
  stage: build
  needs:
    - job: test-backend
      optional: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "Building Docker image"
    - gcloud builds submit --tag gcr.io/$GOOGLE_PROJECT_ID/$GOOGLE_CLOUD_BUILD

deploy:
  stage: deploy
  needs:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "Deploying to Cloud Run"
    - gcloud run deploy $GOOGLE_CLOUD_BUILD \
        --image gcr.io/$GOOGLE_PROJECT_ID/$GOOGLE_CLOUD_BUILD \
        --region 'us-central1' \
        --port 80 \
        --platform managed \
        --allow-unauthenticated \
        --set-env-vars "VITE_API_URL=$API_URL"
# Notes:
# 1. Sensitive variables (API keys, secrets) should be configured via GitLab UI (Settings > CI/CD > Variables) NOT in this file.
# 2. You can customize SAST, Dependency Scanning, etc. via GitLabâ€™s official templates.
# 3. Secret Detection template is included here to prevent accidental commit of secrets.